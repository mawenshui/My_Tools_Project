# SSH客户端开发指南

## 目录
1. [快速开始](#快速开始)
2. [开发环境搭建](#开发环境搭建)
3. [项目结构详解](#项目结构详解)
4. [核心功能开发](#核心功能开发)
5. [调试和测试](#调试和测试)
6. [常见问题解决](#常见问题解决)
7. [贡献指南](#贡献指南)

## 快速开始

### 5分钟上手

1. **克隆项目**
```bash
git clone <项目地址>
cd SSHClient
```

2. **打开项目**
- 启动Qt Creator
- 打开 `SSHClient.pro` 文件
- 选择合适的构建套件

3. **编译运行**
- 按 `Ctrl+B` 编译项目
- 按 `Ctrl+R` 运行程序

4. **基本测试**
- 输入SSH服务器信息
- 选择密钥文件
- 点击连接测试

### 项目概览

```
SSHClient/
├── main.cpp                 # 程序入口
├── sshclient.h/.cpp         # SSH核心功能
├── sshclientwidget.h/.cpp   # 主界面
├── keygendialog.h/.cpp      # 密钥生成对话框
├── *.ui                     # 界面设计文件
├── SSHClient.pro            # 项目配置文件
├── README.md                # 项目说明
└── doc/                     # 文档目录
    ├── 项目规范文档.md
    ├── 代码规范检查清单.md
    ├── API文档.md
    └── 开发指南.md
```

## 开发环境搭建

### 必需软件

#### Windows 平台
1. **Qt 5.12+** (推荐 Qt 5.15 LTS)
   - 下载地址: https://www.qt.io/download
   - 选择开源版本
   - 安装时选择 MinGW 编译器

2. **Qt Creator IDE**
   - 通常与Qt一起安装
   - 或单独下载最新版本

3. **Git**
   - 下载地址: https://git-scm.com/
   - 用于版本控制

4. **OpenSSH客户端**
   - Windows 10/11 通常已预装
   - 或从 https://www.openssh.com/ 下载

#### Linux 平台
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install qt5-default qtcreator build-essential git openssh-client

# CentOS/RHEL
sudo yum install qt5-qtbase-devel qt-creator gcc-c++ git openssh-clients

# Arch Linux
sudo pacman -S qt5-base qtcreator base-devel git openssh
```

### 开发工具推荐

#### 代码编辑器
- **Qt Creator** (主要IDE)
- **Visual Studio Code** (轻量级编辑)
- **CLion** (商业IDE)

#### 调试工具
- **GDB** (命令行调试器)
- **Qt Creator调试器** (图形界面)
- **Valgrind** (内存检查，Linux)

#### 版本控制
- **Git** (必需)
- **GitHub Desktop** (可选图形界面)
- **SourceTree** (可选图形界面)

### 环境配置

#### Qt Creator 配置

1. **构建套件设置**
   - 工具 → 选项 → 构建和运行 → 构建套件
   - 确保编译器、调试器、Qt版本正确配置

2. **代码风格设置**
   - 工具 → 选项 → C++ → 代码风格
   - 导入项目代码风格配置

3. **插件推荐**
   - **Beautifier**: 代码格式化
   - **ClangCodeModel**: 更好的代码补全
   - **Git**: Git集成

#### 环境变量设置

**Windows**:
```cmd
set PATH=%PATH%;C:\Qt\5.15.2\mingw81_64\bin
set QTDIR=C:\Qt\5.15.2\mingw81_64
```

**Linux**:
```bash
export PATH=$PATH:/opt/Qt/5.15.2/gcc_64/bin
export QTDIR=/opt/Qt/5.15.2/gcc_64
```

## 项目结构详解

### 核心文件说明

#### main.cpp
```cpp
// 程序入口点
// 功能:
// 1. 初始化Qt应用程序
// 2. 设置全局日志系统
// 3. 创建并显示主窗口
// 4. 启动事件循环
```

#### sshclient.h/cpp
```cpp
// SSH连接核心类
// 主要功能:
// 1. SSH连接管理
// 2. 命令执行
// 3. 网络状态检查
// 4. 错误处理
```

#### sshclientwidget.h/cpp
```cpp
// 主窗口界面类
// 主要功能:
// 1. 用户界面管理
// 2. 用户输入处理
// 3. 状态显示
// 4. 事件响应
```

#### keygendialog.h/cpp
```cpp
// 密钥生成对话框
// 主要功能:
// 1. 收集密钥生成参数
// 2. 参数验证
// 3. 用户交互
```

### 依赖关系图

```
main.cpp
    ↓
SSHClientWidget
    ↓
┌─────────────┬─────────────┐
│             │             │
SSHClient   KeyGenDialog   UI Files
    ↓           ↓             ↓
Qt Network  Qt Widgets   Qt Designer
```

### 数据流向

```
用户输入 → UI验证 → 业务逻辑 → 系统调用 → 结果处理 → UI更新
    ↑                                                    ↓
    └──────────────── 错误处理 ←──────────────────────────┘
```

## 核心功能开发

### SSH连接功能

#### 基本连接流程

1. **参数验证**
```cpp
bool validateConnectionParams(const QString &host, int port, 
                             const QString &username, const QString &keyFile)
{
    // 检查主机地址
    if (host.isEmpty()) {
        emit connectionError("主机地址不能为空");
        return false;
    }
    
    // 检查端口范围
    if (port < 1 || port > 65535) {
        emit connectionError("端口号必须在1-65535范围内");
        return false;
    }
    
    // 检查用户名
    if (username.isEmpty()) {
        emit connectionError("用户名不能为空");
        return false;
    }
    
    // 检查密钥文件
    if (!QFile::exists(keyFile)) {
        emit connectionError("密钥文件不存在: " + keyFile);
        return false;
    }
    
    return true;
}
```

2. **建立连接**
```cpp
void SSHClient::connectToHost(const QString &host, int port, 
                             const QString &username, const QString &keyFilePath, 
                             const QString &keyFilePassword)
{
    // 参数验证
    if (!validateConnectionParams(host, port, username, keyFilePath)) {
        return;
    }
    
    // 构建SSH命令
    QStringList arguments;
    arguments << "-i" << keyFilePath;  // 指定密钥文件
    arguments << "-p" << QString::number(port);  // 指定端口
    arguments << "-o" << "StrictHostKeyChecking=no";  // 跳过主机验证
    arguments << QString("%1@%2").arg(username).arg(host);
    
    // 启动SSH进程
    m_sshProcess = new QProcess(this);
    connect(m_sshProcess, &QProcess::started, this, &SSHClient::onProcessStarted);
    connect(m_sshProcess, &QProcess::finished, this, &SSHClient::onProcessFinished);
    connect(m_sshProcess, &QProcess::errorOccurred, this, &SSHClient::onProcessError);
    
    m_sshProcess->start("ssh", arguments);
}
```

#### 命令执行功能

```cpp
void SSHClient::executeCommand(const QString &command)
{
    if (!isConnected()) {
        emit commandError("未建立SSH连接");
        return;
    }
    
    // 验证命令
    if (command.isEmpty()) {
        emit commandError("命令不能为空");
        return;
    }
    
    // 执行命令
    m_sshProcess->write(command.toUtf8() + "\n");
}
```

### 密钥生成功能

#### 密钥生成对话框

```cpp
void KeyGenDialog::generateKey()
{
    QString email = ui->emailLineEdit->text();
    QString keyType = ui->keyTypeComboBox->currentText();
    int keyBits = ui->keyBitsSpinBox->value();
    QString password = ui->passwordLineEdit->text();
    
    // 参数验证
    if (!validateKeyGenParams(email, keyType, keyBits)) {
        return;
    }
    
    // 构建ssh-keygen命令
    QStringList arguments;
    arguments << "-t" << keyType.toLower();
    
    if (keyType.toLower() == "rsa") {
        arguments << "-b" << QString::number(keyBits);
    }
    
    arguments << "-C" << email;
    arguments << "-f" << getKeyFilePath();
    
    if (!password.isEmpty()) {
        arguments << "-N" << password;
    } else {
        arguments << "-N" << "";  // 无密码
    }
    
    // 执行密钥生成
    QProcess *keyGenProcess = new QProcess(this);
    connect(keyGenProcess, QOverload<int, QProcess::ExitStatus>::of(&QProcess::finished),
            this, &KeyGenDialog::onKeyGenFinished);
    
    keyGenProcess->start("ssh-keygen", arguments);
}
```

### 网络检测功能

```cpp
void SSHClient::checkNetworkConnection(const QString &host, int port)
{
    QTcpSocket *socket = new QTcpSocket(this);
    
    // 设置超时
    QTimer *timer = new QTimer(this);
    timer->setSingleShot(true);
    timer->setInterval(5000);  // 5秒超时
    
    connect(timer, &QTimer::timeout, [this, socket]() {
        socket->abort();
        emit networkCheckError("连接超时");
        socket->deleteLater();
    });
    
    connect(socket, &QTcpSocket::connected, [this, socket, timer]() {
        timer->stop();
        socket->disconnectFromHost();
        emit networkCheckComplete(true);
        socket->deleteLater();
    });
    
    connect(socket, QOverload<QAbstractSocket::SocketError>::of(&QAbstractSocket::error),
            [this, socket, timer](QAbstractSocket::SocketError error) {
        timer->stop();
        emit networkCheckError(socket->errorString());
        socket->deleteLater();
    });
    
    timer->start();
    socket->connectToHost(host, port);
}
```

## 调试和测试

### 调试技巧

#### 1. 使用Qt Creator调试器

**设置断点**:
- 在代码行号左侧点击设置断点
- 使用条件断点进行精确调试
- 利用数据断点监控变量变化

**调试信息输出**:
```cpp
#include <QDebug>

void SSHClient::connectToHost(const QString &host, int port, 
                             const QString &username, const QString &keyFilePath)
{
    qDebug() << "开始连接SSH服务器:" << host << ":" << port;
    qDebug() << "用户名:" << username;
    qDebug() << "密钥文件:" << keyFilePath;
    
    // ... 连接逻辑
}
```

#### 2. 日志系统使用

```cpp
// 不同级别的日志
qDebug() << "调试信息: 变量值为" << value;
qInfo() << "信息: 连接建立成功";
qWarning() << "警告: 密钥文件权限可能不正确";
qCritical() << "严重错误: 无法创建SSH进程";
```

#### 3. 内存泄漏检测

**Windows (Application Verifier)**:
```cmd
appverif.exe /verify SSHClient.exe
```

**Linux (Valgrind)**:
```bash
valgrind --tool=memcheck --leak-check=full ./SSHClient
```

### 单元测试

#### 测试框架设置

1. **创建测试项目**
```pro
# test.pro
QT += testlib core
CONFIG += testcase

TARGET = SSHClientTest
TEMPLATE = app

SOURCES += \
    test_sshclient.cpp \
    ../sshclient.cpp

HEADERS += \
    ../sshclient.h
```

2. **编写测试用例**
```cpp
#include <QtTest>
#include "../sshclient.h"

class TestSSHClient : public QObject
{
    Q_OBJECT

private slots:
    void initTestCase();  // 测试开始前调用
    void cleanupTestCase();  // 测试结束后调用
    void init();  // 每个测试用例前调用
    void cleanup();  // 每个测试用例后调用
    
    // 测试用例
    void testConnectionValidation();
    void testNetworkCheck();
    void testCommandExecution();
    
private:
    SSHClient *m_sshClient;
};

void TestSSHClient::initTestCase()
{
    m_sshClient = new SSHClient(this);
}

void TestSSHClient::testConnectionValidation()
{
    // 测试空主机地址
    QSignalSpy errorSpy(m_sshClient, &SSHClient::connectionError);
    m_sshClient->connectToHost("", 22, "user", "/path/to/key");
    QCOMPARE(errorSpy.count(), 1);
    
    // 测试无效端口
    errorSpy.clear();
    m_sshClient->connectToHost("localhost", 0, "user", "/path/to/key");
    QCOMPARE(errorSpy.count(), 1);
}

QTEST_MAIN(TestSSHClient)
#include "test_sshclient.moc"
```

#### 集成测试

```cpp
class IntegrationTest : public QObject
{
    Q_OBJECT
    
private slots:
    void testFullConnectionFlow();
    void testKeyGeneration();
    void testUIInteraction();
};

void IntegrationTest::testFullConnectionFlow()
{
    SSHClientWidget widget;
    widget.show();
    
    // 模拟用户输入
    QTest::keyClicks(widget.findChild<QLineEdit*>("hostLineEdit"), "localhost");
    QTest::keyClicks(widget.findChild<QLineEdit*>("usernameLineEdit"), "testuser");
    
    // 模拟按钮点击
    QTest::mouseClick(widget.findChild<QPushButton*>("connectButton"), Qt::LeftButton);
    
    // 等待连接结果
    QTest::qWait(1000);
    
    // 验证结果
    QVERIFY(widget.findChild<QLabel*>("statusLabel")->text().contains("连接"));
}
```

### 性能测试

#### 连接性能测试

```cpp
void PerformanceTest::testConnectionSpeed()
{
    SSHClient client;
    QElapsedTimer timer;
    
    timer.start();
    
    QSignalSpy connectedSpy(&client, &SSHClient::connected);
    client.connectToHost("localhost", 22, "user", "/path/to/key");
    
    QVERIFY(connectedSpy.wait(5000));  // 最多等待5秒
    
    qint64 elapsed = timer.elapsed();
    qDebug() << "连接耗时:" << elapsed << "毫秒";
    
    QVERIFY(elapsed < 3000);  // 连接应在3秒内完成
}
```

#### 内存使用测试

```cpp
void PerformanceTest::testMemoryUsage()
{
    size_t initialMemory = getCurrentMemoryUsage();
    
    // 创建多个SSH连接
    QList<SSHClient*> clients;
    for (int i = 0; i < 10; ++i) {
        clients.append(new SSHClient());
    }
    
    size_t peakMemory = getCurrentMemoryUsage();
    
    // 清理资源
    qDeleteAll(clients);
    clients.clear();
    
    size_t finalMemory = getCurrentMemoryUsage();
    
    qDebug() << "初始内存:" << initialMemory;
    qDebug() << "峰值内存:" << peakMemory;
    qDebug() << "最终内存:" << finalMemory;
    
    // 验证内存泄漏
    QVERIFY(finalMemory - initialMemory < 1024 * 1024);  // 泄漏小于1MB
}
```

## 常见问题解决

### 编译问题

#### 问题1: Qt版本不兼容
**错误信息**: `Project ERROR: Unknown module(s) in QT: widgets`

**解决方案**:
```pro
# 在.pro文件中添加
greaterThan(QT_MAJOR_VERSION, 4): QT += widgets
```

#### 问题2: 编译器找不到头文件
**错误信息**: `fatal error: QApplication: No such file or directory`

**解决方案**:
1. 检查Qt安装路径
2. 重新配置构建套件
3. 确保包含路径正确

```pro
INCLUDEPATH += $$[QT_INSTALL_HEADERS]
```

### 运行时问题

#### 问题1: SSH连接失败
**错误信息**: `Connection refused`

**排查步骤**:
1. 检查目标主机是否可达
```bash
ping target_host
```

2. 检查SSH服务是否运行
```bash
sudo systemctl status ssh  # Linux
```

3. 检查防火墙设置
```bash
sudo ufw status  # Ubuntu
sudo firewall-cmd --list-all  # CentOS
```

#### 问题2: 密钥认证失败
**错误信息**: `Permission denied (publickey)`

**解决方案**:
1. 检查密钥文件权限
```bash
chmod 600 ~/.ssh/id_rsa
chmod 644 ~/.ssh/id_rsa.pub
```

2. 检查公钥是否已部署
```bash
cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
```

3. 检查SSH配置
```bash
# /etc/ssh/sshd_config
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys
```

#### 问题3: 界面无响应
**原因**: 在UI线程中执行耗时操作

**解决方案**:
```cpp
// 错误做法
void MyWidget::onButtonClicked()
{
    // 这会阻塞UI线程
    QThread::sleep(5);
}

// 正确做法
void MyWidget::onButtonClicked()
{
    QFuture<void> future = QtConcurrent::run([this]() {
        // 耗时操作在后台线程执行
        doLongRunningTask();
    });
    
    // 监控完成状态
    QFutureWatcher<void> *watcher = new QFutureWatcher<void>(this);
    connect(watcher, &QFutureWatcher<void>::finished, [this, watcher]() {
        // 在UI线程中更新界面
        updateUI();
        watcher->deleteLater();
    });
    watcher->setFuture(future);
}
```

### 调试技巧

#### 网络问题调试

```cpp
void SSHClient::debugNetworkIssue(const QString &host, int port)
{
    qDebug() << "开始网络诊断...";
    
    // 1. DNS解析测试
    QHostInfo::lookupHost(host, [](const QHostInfo &info) {
        if (info.error() != QHostInfo::NoError) {
            qDebug() << "DNS解析失败:" << info.errorString();
        } else {
            qDebug() << "DNS解析成功:" << info.addresses();
        }
    });
    
    // 2. TCP连接测试
    QTcpSocket *socket = new QTcpSocket(this);
    connect(socket, &QTcpSocket::connected, [this]() {
        qDebug() << "TCP连接成功";
    });
    connect(socket, QOverload<QAbstractSocket::SocketError>::of(&QAbstractSocket::error),
            [this](QAbstractSocket::SocketError error) {
        qDebug() << "TCP连接失败:" << error;
    });
    
    socket->connectToHost(host, port);
}
```

#### 进程调试

```cpp
void SSHClient::debugProcessIssue()
{
    connect(m_sshProcess, &QProcess::started, [this]() {
        qDebug() << "SSH进程启动成功, PID:" << m_sshProcess->processId();
    });
    
    connect(m_sshProcess, &QProcess::errorOccurred, 
            [this](QProcess::ProcessError error) {
        qDebug() << "进程错误:" << error;
        switch (error) {
        case QProcess::FailedToStart:
            qDebug() << "进程启动失败，检查ssh命令是否存在";
            break;
        case QProcess::Crashed:
            qDebug() << "进程崩溃";
            break;
        case QProcess::Timedout:
            qDebug() << "进程超时";
            break;
        default:
            qDebug() << "未知进程错误";
        }
    });
    
    connect(m_sshProcess, &QProcess::readyReadStandardOutput, [this]() {
        QByteArray data = m_sshProcess->readAllStandardOutput();
        qDebug() << "标准输出:" << data;
    });
    
    connect(m_sshProcess, &QProcess::readyReadStandardError, [this]() {
        QByteArray data = m_sshProcess->readAllStandardError();
        qDebug() << "错误输出:" << data;
    });
}
```

## 贡献指南

### 代码贡献流程

1. **Fork项目**
   - 在GitHub上Fork项目到个人账户
   - 克隆Fork的仓库到本地

2. **创建功能分支**
```bash
git checkout -b feature/new-feature-name
```

3. **开发和测试**
   - 按照代码规范编写代码
   - 添加必要的测试用例
   - 确保所有测试通过

4. **提交代码**
```bash
git add .
git commit -m "[新增] 添加新功能描述"
git push origin feature/new-feature-name
```

5. **创建Pull Request**
   - 在GitHub上创建Pull Request
   - 详细描述修改内容和原因
   - 等待代码审查

### 代码审查标准

#### 功能性检查
- [ ] 功能是否按预期工作
- [ ] 是否处理了边界条件
- [ ] 错误处理是否完善
- [ ] 是否有足够的测试覆盖

#### 代码质量检查
- [ ] 代码风格是否符合项目规范
- [ ] 命名是否清晰有意义
- [ ] 函数是否过于复杂
- [ ] 是否有重复代码

#### 性能检查
- [ ] 是否有性能瓶颈
- [ ] 内存使用是否合理
- [ ] 是否有不必要的资源消耗

#### 安全检查
- [ ] 输入验证是否充分
- [ ] 是否有安全漏洞
- [ ] 敏感信息处理是否安全

### 文档贡献

#### 文档类型
- **API文档**: 描述类和方法的使用
- **用户手册**: 面向最终用户的使用指南
- **开发文档**: 面向开发者的技术文档
- **示例代码**: 演示功能使用的代码示例

#### 文档规范
- 使用Markdown格式
- 保持内容准确和最新
- 提供清晰的示例
- 支持中英文双语（优先中文）

### 问题报告

#### Bug报告模板
```markdown
## Bug描述
简要描述遇到的问题

## 复现步骤
1. 第一步
2. 第二步
3. 第三步

## 预期行为
描述期望的正确行为

## 实际行为
描述实际发生的错误行为

## 环境信息
- 操作系统: Windows 10 / Ubuntu 20.04
- Qt版本: 5.15.2
- 编译器: MinGW 8.1.0 / GCC 9.4.0
- 项目版本: v1.2.0

## 附加信息
- 错误日志
- 截图
- 其他相关信息
```

#### 功能请求模板
```markdown
## 功能描述
详细描述希望添加的功能

## 使用场景
说明什么情况下需要这个功能

## 解决方案
建议的实现方案（可选）

## 替代方案
其他可能的解决方案（可选）

## 优先级
- [ ] 高优先级
- [ ] 中优先级
- [ ] 低优先级
```

### 发布流程

#### 版本号规则
- **主版本号**: 不兼容的API修改
- **次版本号**: 向下兼容的功能性新增
- **修订版本号**: 向下兼容的问题修正

#### 发布检查清单
- [ ] 所有测试通过
- [ ] 文档已更新
- [ ] 更新日志已编写
- [ ] 版本号已更新
- [ ] 创建Git标签
- [ ] 构建发布包
- [ ] 发布说明已发布

## 学习资源

### Qt学习资源
- [Qt官方文档](https://doc.qt.io/)
- [Qt Creator手册](https://doc.qt.io/qtcreator/)
- [Qt示例和教程](https://doc.qt.io/qt-5/qtexamplesandtutorials.html)

### C++学习资源
- [C++ Reference](https://en.cppreference.com/)
- [Modern C++ Guidelines](https://github.com/isocpp/CppCoreGuidelines)
- [Effective C++](https://www.aristeia.com/books.html)

### SSH相关资源
- [OpenSSH手册](https://www.openssh.com/manual.html)
- [SSH协议规范](https://tools.ietf.org/html/rfc4251)
- [SSH密钥管理最佳实践](https://www.ssh.com/academy/ssh/key-management)

### 开发工具
- [Git教程](https://git-scm.com/book)
- [GitHub使用指南](https://guides.github.com/)
- [Markdown语法](https://www.markdownguide.org/)

## 联系方式

- **项目仓库**: [GitHub链接]
- **问题反馈**: [Issues链接]
- **技术讨论**: [讨论区链接]
- **邮件联系**: [邮箱地址]

---

**文档版本**: 1.0  
**最后更新**: 2024年  
**维护者**: 项目开发团队

欢迎加入SSH客户端项目的开发！如果您有任何问题或建议，请随时联系我们。